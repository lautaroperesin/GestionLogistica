<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:GestionLogisticaApp.ViewModels"
             xmlns:local="clr-namespace:GestionLogisticaApp"
             x:Class="GestionLogisticaApp.EnviosPorConductorPage"
             x:Name="EnviosPorConductorPageRoot"
             Title="Mis Envios"
             BackgroundColor="#F8F9FA">

    <ContentPage.BindingContext>
        <vm:EnviosPorConductorViewModel />
    </ContentPage.BindingContext>

    <Grid>
        <!-- Fondo decorativo superior -->
        <BoxView HeightRequest="200" VerticalOptions="Start">
            <BoxView.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#667eea" Offset="0.0" />
                    <GradientStop Color="#764ba2" Offset="1.0" />
                </LinearGradientBrush>
            </BoxView.Background>
        </BoxView>

        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="20">
                
                <!-- Header con información del conductor -->
                <Frame Padding="25" 
                       CornerRadius="20" 
                       BackgroundColor="White" 
                       HasShadow="True"
                       Margin="0,10,0,0">
                    <Frame.Shadow>
                        <Shadow Brush="Black" Offset="0,4" Radius="15" Opacity="0.1"/>
                    </Frame.Shadow>
                    
                    <VerticalStackLayout Spacing="15">
                        <!-- Boton volver -->
                        <Button Text="&#x2190; Volver"
                                Command="{Binding GoBackCommand}"
                                BackgroundColor="Transparent"
                                TextColor="#667eea"
                                FontSize="16"
                                FontAttributes="Bold"
                                HorizontalOptions="Start"
                                Padding="0"
                                Margin="0,0,0,10"/>
                        
                        <!-- Mostrar mensaje de error si existe -->
                        <Frame IsVisible="{Binding ErrorMessage, Converter={StaticResource StringNotEmptyConverter}}"
                               Padding="15" 
                               CornerRadius="10" 
                               BackgroundColor="#FEE2E2"
                               BorderColor="#EF4444"
                               HasShadow="False"
                               Margin="0,0,0,10">
                            <HorizontalStackLayout Spacing="10">
                                <Label Text="&#x26A0;" 
                                       FontSize="20" 
                                       TextColor="#EF4444"
                                       VerticalOptions="Center"/>
                                <Label Text="{Binding ErrorMessage}" 
                                       FontSize="14" 
                                       TextColor="#991B1B"
                                       VerticalOptions="Center"
                                       LineBreakMode="WordWrap"
                                       HorizontalOptions="FillAndExpand"/>
                            </HorizontalStackLayout>
                        </Frame>

                        <!-- Información del conductor actual -->
                        <Label Text="Mis Envíos Asignados" 
                               FontAttributes="Bold" 
                               FontSize="20" 
                               TextColor="#333333" />
                        
                        <Frame Padding="15" 
                               CornerRadius="12" 
                               BorderColor="#E0E0E0"
                               HasShadow="False"
                               BackgroundColor="#F8F9FA"
                               IsVisible="{Binding CurrentUser, Converter={StaticResource IsNotNullConverter}}">
                            <HorizontalStackLayout Spacing="10">
                                <Label Text="&#x1F464;" FontSize="24" VerticalOptions="Center"/>
                                <VerticalStackLayout Spacing="4" HorizontalOptions="FillAndExpand">
                                    <Label Text="{Binding CurrentUser.Email}" 
                                           FontSize="14" 
                                           FontAttributes="Bold"
                                           TextColor="#333333"/>
                                    <Label Text="Conductor" 
                                           FontSize="12" 
                                           TextColor="#666666"/>
                                </VerticalStackLayout>
                            </HorizontalStackLayout>
                        </Frame>
                    </VerticalStackLayout>
                </Frame>

                <!-- Pendientes -->
                <VerticalStackLayout Spacing="10" IsVisible="{Binding ErrorMessage, Converter={StaticResource StringEmptyConverter}}">
                    <Frame Padding="15,10" 
                           CornerRadius="10" 
                           BackgroundColor="#FFF9E6"
                           HasShadow="False"
                           HorizontalOptions="Start">
                        <Label Text="&#x23F3; Pendientes" 
                               FontAttributes="Bold" 
                               FontSize="18" 
                               TextColor="#F59E0B"/>
                    </Frame>
                    
                    <CollectionView ItemsSource="{Binding EnviosPendientes}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame CornerRadius="15" 
                                       BackgroundColor="White" 
                                       Padding="20" 
                                       Margin="0,0,0,12" 
                                       HasShadow="True"
                                       BorderColor="#F59E0B">
                                    <Frame.Shadow>
                                        <Shadow Brush="Black" Offset="0,2" Radius="8" Opacity="0.08"/>
                                    </Frame.Shadow>
                                    
                                    <VerticalStackLayout Spacing="12">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <BoxView BackgroundColor="#F59E0B" 
                                                     WidthRequest="4" 
                                                     HeightRequest="24"
                                                     CornerRadius="2"
                                                     VerticalOptions="Center"/>
                                            <Label Grid.Column="1"
                                                   Text="{Binding NumeroSeguimiento}" 
                                                   FontAttributes="Bold" 
                                                   FontSize="17" 
                                                   TextColor="#333333"
                                                   Margin="12,0,0,0"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                        
                                        <BoxView Color="#F0F0F0" HeightRequest="1"/>
                                        
                                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" ColumnSpacing="10" RowSpacing="8">
                                            <Label Grid.Row="0" Grid.Column="0" Text="&#x1F4CD;" FontSize="16" VerticalOptions="Start"/>
                                            <Label Grid.Row="0" Grid.Column="1" Text="{Binding Origen.DireccionCompleta}" FontSize="14" TextColor="#666666" LineBreakMode="WordWrap"/>
                                            
                                            <Label Grid.Row="1" Grid.Column="0" Text="&#x1F3AF;" FontSize="16" VerticalOptions="Start"/>
                                            <Label Grid.Row="1" Grid.Column="1" Text="{Binding Destino.DireccionCompleta}" FontSize="14" TextColor="#666666" LineBreakMode="WordWrap"/>
                                        </Grid>
                                        
                                        <Button Text="VER DETALLE" 
                                                Command="{Binding Source={x:Reference EnviosPorConductorPageRoot}, Path=BindingContext.ViewDetalleCommand}" 
                                                CommandParameter="{Binding}" 
                                                BackgroundColor="#667eea"
                                                TextColor="White"
                                                FontSize="14"
                                                FontAttributes="Bold"
                                                CornerRadius="10"
                                                HeightRequest="45"
                                                Margin="0,5,0,0"/>
                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- En transito -->
                <VerticalStackLayout Spacing="10" IsVisible="{Binding ErrorMessage, Converter={StaticResource StringEmptyConverter}}">
                    <Frame Padding="15,10" 
                           CornerRadius="10" 
                           BackgroundColor="#E6F2FF"
                           HasShadow="False"
                           HorizontalOptions="Start">
                        <Label Text="&#x1F69A; En Tránsito" 
                               FontAttributes="Bold" 
                               FontSize="18" 
                               TextColor="#3B82F6"/>
                    </Frame>
                    
                    <CollectionView ItemsSource="{Binding EnviosEnTransito}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame CornerRadius="15" 
                                       BackgroundColor="White" 
                                       Padding="20" 
                                       Margin="0,0,0,12" 
                                       HasShadow="True"
                                       BorderColor="#3B82F6">
                                    <Frame.Shadow>
                                        <Shadow Brush="Black" Offset="0,2" Radius="8" Opacity="0.08"/>
                                    </Frame.Shadow>
                                    
                                    <VerticalStackLayout Spacing="12">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <BoxView BackgroundColor="#3B82F6" 
                                                     WidthRequest="4" 
                                                     HeightRequest="24"
                                                     CornerRadius="2"
                                                     VerticalOptions="Center"/>
                                            <Label Grid.Column="1"
                                                   Text="{Binding NumeroSeguimiento}" 
                                                   FontAttributes="Bold" 
                                                   FontSize="17" 
                                                   TextColor="#333333"
                                                   Margin="12,0,0,0"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                        
                                        <BoxView Color="#F0F0F0" HeightRequest="1"/>
                                        
                                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" ColumnSpacing="10" RowSpacing="8">
                                            <Label Grid.Row="0" Grid.Column="0" Text="&#x1F4CD;" FontSize="16" VerticalOptions="Start"/>
                                            <Label Grid.Row="0" Grid.Column="1" Text="{Binding Origen.DireccionCompleta}" FontSize="14" TextColor="#666666" LineBreakMode="WordWrap"/>
                                            
                                            <Label Grid.Row="1" Grid.Column="0" Text="&#x1F3AF;" FontSize="16" VerticalOptions="Start"/>
                                            <Label Grid.Row="1" Grid.Column="1" Text="{Binding Destino.DireccionCompleta}" FontSize="14" TextColor="#666666" LineBreakMode="WordWrap"/>
                                        </Grid>
                                        
                                        <Button Text="VER DETALLE" 
                                                Command="{Binding Source={x:Reference EnviosPorConductorPageRoot}, Path=BindingContext.ViewDetalleCommand}" 
                                                CommandParameter="{Binding}" 
                                                BackgroundColor="#667eea"
                                                TextColor="White"
                                                FontSize="14"
                                                FontAttributes="Bold"
                                                CornerRadius="10"
                                                HeightRequest="45"
                                                Margin="0,5,0,0"/>
                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Entregados -->
                <VerticalStackLayout Spacing="10" IsVisible="{Binding ErrorMessage, Converter={StaticResource StringEmptyConverter}}">
                    <Frame Padding="15,10" 
                           CornerRadius="10" 
                           BackgroundColor="#ECFDF5"
                           HasShadow="False"
                           HorizontalOptions="Start">
                        <Label Text="&#x2705; Entregados" 
                               FontAttributes="Bold" 
                               FontSize="18" 
                               TextColor="#10B981"/>
                    </Frame>
                    
                    <CollectionView ItemsSource="{Binding EnviosEntregados}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame CornerRadius="15" 
                                       BackgroundColor="White" 
                                       Padding="20" 
                                       Margin="0,0,0,12" 
                                       HasShadow="True"
                                       BorderColor="#10B981">
                                    <Frame.Shadow>
                                        <Shadow Brush="Black" Offset="0,2" Radius="8" Opacity="0.08"/>
                                    </Frame.Shadow>
                                    
                                    <VerticalStackLayout Spacing="12">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <BoxView BackgroundColor="#10B981" 
                                                     WidthRequest="4" 
                                                     HeightRequest="24"
                                                     CornerRadius="2"
                                                     VerticalOptions="Center"/>
                                            <Label Grid.Column="1"
                                                   Text="{Binding NumeroSeguimiento}" 
                                                   FontAttributes="Bold" 
                                                   FontSize="17" 
                                                   TextColor="#333333"
                                                   Margin="12,0,0,0"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                        
                                        <BoxView Color="#F0F0F0" HeightRequest="1"/>
                                        
                                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" ColumnSpacing="10" RowSpacing="8">
                                            <Label Grid.Row="0" Grid.Column="0" Text="&#x1F4CD;" FontSize="16" VerticalOptions="Start"/>
                                            <Label Grid.Row="0" Grid.Column="1" Text="{Binding Origen.DireccionCompleta}" FontSize="14" TextColor="#666666" LineBreakMode="WordWrap"/>
                                            
                                            <Label Grid.Row="1" Grid.Column="0" Text="&#x1F3AF;" FontSize="16" VerticalOptions="Start"/>
                                            <Label Grid.Row="1" Grid.Column="1" Text="{Binding Destino.DireccionCompleta}" FontSize="14" TextColor="#666666" LineBreakMode="WordWrap"/>
                                        </Grid>
                                        
                                        <Button Text="VER DETALLE" 
                                                Command="{Binding Source={x:Reference EnviosPorConductorPageRoot}, Path=BindingContext.ViewDetalleCommand}" 
                                                CommandParameter="{Binding}" 
                                                BackgroundColor="#667eea"
                                                TextColor="White"
                                                FontSize="14"
                                                FontAttributes="Bold"
                                                CornerRadius="10"
                                                HeightRequest="45"
                                                Margin="0,5,0,0"/>
                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Demorados -->
                <VerticalStackLayout Spacing="10" IsVisible="{Binding ErrorMessage, Converter={StaticResource StringEmptyConverter}}">
                    <Frame Padding="15,10" 
                           CornerRadius="10" 
                           BackgroundColor="#FFF4E6"
                           HasShadow="False"
                           HorizontalOptions="Start">
                        <Label Text="&#x26A0; Demorados" 
                               FontAttributes="Bold" 
                               FontSize="18" 
                               TextColor="#F97316"/>
                    </Frame>
                    
                    <CollectionView ItemsSource="{Binding EnviosDemorados}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame CornerRadius="15" 
                                       BackgroundColor="White" 
                                       Padding="20" 
                                       Margin="0,0,0,12" 
                                       HasShadow="True"
                                       BorderColor="#F97316">
                                    <Frame.Shadow>
                                        <Shadow Brush="Black" Offset="0,2" Radius="8" Opacity="0.08"/>
                                    </Frame.Shadow>
                                    
                                    <VerticalStackLayout Spacing="12">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <BoxView BackgroundColor="#F97316" 
                                                     WidthRequest="4" 
                                                     HeightRequest="24"
                                                     CornerRadius="2"
                                                     VerticalOptions="Center"/>
                                            <Label Grid.Column="1"
                                                   Text="{Binding NumeroSeguimiento}" 
                                                   FontAttributes="Bold" 
                                                   FontSize="17" 
                                                   TextColor="#333333"
                                                   Margin="12,0,0,0"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                        
                                        <BoxView Color="#F0F0F0" HeightRequest="1"/>
                                        
                                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" ColumnSpacing="10" RowSpacing="8">
                                            <Label Grid.Row="0" Grid.Column="0" Text="&#x1F4CD;" FontSize="16" VerticalOptions="Start"/>
                                            <Label Grid.Row="0" Grid.Column="1" Text="{Binding Origen.DireccionCompleta}" FontSize="14" TextColor="#666666" LineBreakMode="WordWrap"/>
                                            
                                            <Label Grid.Row="1" Grid.Column="0" Text="&#x1F3AF;" FontSize="16" VerticalOptions="Start"/>
                                            <Label Grid.Row="1" Grid.Column="1" Text="{Binding Destino.DireccionCompleta}" FontSize="14" TextColor="#666666" LineBreakMode="WordWrap"/>
                                        </Grid>
                                        
                                        <Button Text="VER DETALLE" 
                                                Command="{Binding Source={x:Reference EnviosPorConductorPageRoot}, Path=BindingContext.ViewDetalleCommand}" 
                                                CommandParameter="{Binding}" 
                                                BackgroundColor="#667eea"
                                                TextColor="White"
                                                FontSize="14"
                                                FontAttributes="Bold"
                                                CornerRadius="10"
                                                HeightRequest="45"
                                                Margin="0,5,0,0"/>
                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Cancelados -->
                <VerticalStackLayout Spacing="10" IsVisible="{Binding ErrorMessage, Converter={StaticResource StringEmptyConverter}}">
                    <Frame Padding="15,10" 
                           CornerRadius="10" 
                           BackgroundColor="#FEE2E2"
                           HasShadow="False"
                           HorizontalOptions="Start">
                        <Label Text="&#x274C; Cancelados" 
                               FontAttributes="Bold" 
                               FontSize="18" 
                               TextColor="#EF4444"/>
                    </Frame>
                    
                    <CollectionView ItemsSource="{Binding EnviosCancelados}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame CornerRadius="15" 
                                       BackgroundColor="White" 
                                       Padding="20" 
                                       Margin="0,0,0,12" 
                                       HasShadow="True"
                                       BorderColor="#EF4444">
                                    <Frame.Shadow>
                                        <Shadow Brush="Black" Offset="0,2" Radius="8" Opacity="0.08"/>
                                    </Frame.Shadow>
                                    
                                    <VerticalStackLayout Spacing="12">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <BoxView BackgroundColor="#EF4444" 
                                                     WidthRequest="4" 
                                                     HeightRequest="24"
                                                     CornerRadius="2"
                                                     VerticalOptions="Center"/>
                                            <Label Grid.Column="1"
                                                   Text="{Binding NumeroSeguimiento}" 
                                                   FontAttributes="Bold" 
                                                   FontSize="17" 
                                                   TextColor="#333333"
                                                   Margin="12,0,0,0"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                        
                                        <BoxView Color="#F0F0F0" HeightRequest="1"/>
                                        
                                        <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" ColumnSpacing="10" RowSpacing="8">
                                            <Label Grid.Row="0" Grid.Column="0" Text="&#x1F4CD;" FontSize="16" VerticalOptions="Start"/>
                                            <Label Grid.Row="0" Grid.Column="1" Text="{Binding Origen.DireccionCompleta}" FontSize="14" TextColor="#666666" LineBreakMode="WordWrap"/>
                                            
                                            <Label Grid.Row="1" Grid.Column="0" Text="&#x1F3AF;" FontSize="16" VerticalOptions="Start"/>
                                            <Label Grid.Row="1" Grid.Column="1" Text="{Binding Destino.DireccionCompleta}" FontSize="14" TextColor="#666666" LineBreakMode="WordWrap"/>
                                        </Grid>
                                        
                                        <Button Text="VER DETALLE" 
                                                Command="{Binding Source={x:Reference EnviosPorConductorPageRoot}, Path=BindingContext.ViewDetalleCommand}" 
                                                CommandParameter="{Binding}" 
                                                BackgroundColor="#667eea"
                                                TextColor="White"
                                                FontSize="14"
                                                FontAttributes="Bold"
                                                CornerRadius="10"
                                                HeightRequest="45"
                                                Margin="0,5,0,0"/>
                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Espacio inferior -->
                <BoxView HeightRequest="20" BackgroundColor="Transparent"/>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Overlay de carga -->
        <Grid IsVisible="{Binding IsBusy}"
              BackgroundColor="#80000000"
              VerticalOptions="Fill"
              HorizontalOptions="Fill">
            <Frame CornerRadius="20"
                   BackgroundColor="White"
                   Padding="40"
                   WidthRequest="270"
                   HeightRequest="270"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   HasShadow="True">
                <VerticalStackLayout Spacing="20"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center">
                    <ActivityIndicator IsRunning="{Binding IsBusy}"
                                     Color="#667eea"
                                     WidthRequest="60"
                                     HeightRequest="50"
                                     HorizontalOptions="Center"/>
                    <Label Text="Cargando envíos..."
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="#333333"
                           HorizontalOptions="Center"/>
                    <Label Text="Por favor espera"
                           FontSize="14"
                           TextColor="#666666"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Frame>
        </Grid>
    </Grid>
</ContentPage>